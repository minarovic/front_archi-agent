name: Validate Scrum Stories

on:
  push:
    branches: [main]
    paths:
      - "scrum/**"
      - ".github/workflows/validate-stories.yml"
  pull_request:
    branches: [main]
    paths:
      - "scrum/**"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate story metadata
        run: |
          echo "üìã Validating Scrum story structure..."

          # Check for required frontmatter fields in story files
          for file in scrum/backlog/*.md scrum/doing/*.md scrum/done/*.md; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              if ! grep -q "^id:" "$file"; then
                echo "‚ùå Missing 'id' in $file"
                exit 1
              fi
              if ! grep -q "^title:" "$file"; then
                echo "‚ùå Missing 'title' in $file"
                exit 1
              fi
              if ! grep -q "^status:" "$file"; then
                echo "‚ùå Missing 'status' in $file"
                exit 1
              fi
            fi
          done

          echo "‚úÖ All stories validated"

      - name: Check story status consistency
        run: |
          echo "üîç Checking story status consistency..."

          # Stories in backlog/ should have status: backlog or planned
          for file in scrum/backlog/*.md; do
            if [ -f "$file" ]; then
              status=$(grep "^status:" "$file" | cut -d: -f2 | xargs)
              if [[ "$status" != "backlog" && "$status" != "planned" ]]; then
                echo "‚ö†Ô∏è  Story $file in backlog/ has status: $status (should be backlog or planned)"
              fi
            fi
          done

          # Stories in doing/ should have status: in-progress or doing
          for file in scrum/doing/*.md; do
            if [ -f "$file" ]; then
              status=$(grep "^status:" "$file" | cut -d: -f2 | xargs)
              if [[ "$status" != "in-progress" && "$status" != "doing" ]]; then
                echo "‚ö†Ô∏è  Story $file in doing/ has status: $status (should be in-progress or doing)"
              fi
            fi
          done

          # Stories in done/ should have status: done or completed
          for file in scrum/done/*.md; do
            if [ -f "$file" ]; then
              status=$(grep "^status:" "$file" | cut -d: -f2 | xargs)
              if [[ "$status" != "done" && "$status" != "completed" ]]; then
                echo "‚ö†Ô∏è  Story $file in done/ has status: $status (should be done or completed)"
              fi
            fi
          done

          echo "‚úÖ Status consistency checked"
